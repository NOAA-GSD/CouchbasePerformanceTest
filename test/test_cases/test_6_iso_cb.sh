#!/usr/bin/env bash
source ./getopts.sh
read -d '' prologue << PEOF
This is a test of a query captured from a basic die-off plot from the metviewer at
http://137.75.129.120:8080/metviewer-mysql/servlet  - historical plot named 20200515_162720.
PEOF
/opt/couchbase/bin/cbq -o "output/$0.json" -q -e couchbase://${server}/mdata -u met_admin -p met_adm_pwd <<-'EOF' 

SELECT r.mdata.geoLocation_id as vx_mask, data.fcst_init_beg, data.fcst_valid_beg, data.fcst_lead, r.mdata.model, r.mdata.fcst_lev, r.mdata.fcst_var, data.total, data.uoabar, data.voabar, data.ufabar, data.vfabar, data.uvooabar, data.uvfoabar, data.uvffabar
FROM (
    SELECT *
    FROM mdata
    WHERE model == "GFS"
        AND dataType == "VSDB_V01_VAL1L2"
        AND subset == "mv_gfs_grid2obs_vsdb1"
        AND geoLocation_id IN ["G2/NHX","G2/SHX"]
        AND fcst_var == "WIND"
        AND fcst_lev in ['P500']
        AND fcst_valid_beg IN 
	[
	'2019-01-01T00:00:00Z',
	'2019-01-01T06:00:00Z',
	'2019-01-01T12:00:00Z',
	'2019-01-01T18:00:00Z',
	'2019-01-02T00:00:00Z',
	'2019-01-02T06:00:00Z',
	'2019-01-02T12:00:00Z',
	'2019-01-02T18:00:00Z',
	'2019-01-03T00:00:00Z',
	'2019-01-03T06:00:00Z',
	'2019-01-03T12:00:00Z',
	'2019-01-03T18:00:00Z',
	'2019-01-04T00:00:00Z',
	'2019-01-04T06:00:00Z',
	'2019-01-04T12:00:00Z',
	'2019-01-04T18:00:00Z',
	'2019-01-05T00:00:00Z',
	'2019-01-05T06:00:00Z',
	'2019-01-05T12:00:00Z',
	'2019-01-05T18:00:00Z',
	'2019-01-06T00:00:00Z',
	'2019-01-06T06:00:00Z',
	'2019-01-06T12:00:00Z',
	'2019-01-06T18:00:00Z',
	'2019-01-07T00:00:00Z',
	'2019-01-07T06:00:00Z',
	'2019-01-07T12:00:00Z',
	'2019-01-07T18:00:00Z',
	'2019-01-08T00:00:00Z',
	'2019-01-08T06:00:00Z',
	'2019-01-08T12:00:00Z',
	'2019-01-08T18:00:00Z',
	'2019-01-09T00:00:00Z',
	'2019-01-09T06:00:00Z',
	'2019-01-09T12:00:00Z',
	'2019-01-09T18:00:00Z',
	'2019-01-10T00:00:00Z',
	'2019-01-10T06:00:00Z',
	'2019-01-10T12:00:00Z',
	'2019-01-10T18:00:00Z',
	'2019-01-11T00:00:00Z',
	'2019-01-11T06:00:00Z',
	'2019-01-11T12:00:00Z',
	'2019-01-11T18:00:00Z',
	'2019-01-12T00:00:00Z',
	'2019-01-12T06:00:00Z',
	'2019-01-12T12:00:00Z',
	'2019-01-12T18:00:00Z',
	'2019-01-13T00:00:00Z',
	'2019-01-13T06:00:00Z',
	'2019-01-13T12:00:00Z',
	'2019-01-13T18:00:00Z',
	'2019-01-14T00:00:00Z',
	'2019-01-14T06:00:00Z',
	'2019-01-14T12:00:00Z',
	'2019-01-14T18:00:00Z',
	'2019-01-15T00:00:00Z',
	'2019-01-15T06:00:00Z',
	'2019-01-15T12:00:00Z',
	'2019-01-15T18:00:00Z',
	'2019-01-16T00:00:00Z',
	'2019-01-16T06:00:00Z',
	'2019-01-16T12:00:00Z',
	'2019-01-16T18:00:00Z',
	'2019-01-17T00:00:00Z',
	'2019-01-17T06:00:00Z',
	'2019-01-17T12:00:00Z',
	'2019-01-17T18:00:00Z',
	'2019-01-18T00:00:00Z',
	'2019-01-18T06:00:00Z',
	'2019-01-18T12:00:00Z',
	'2019-01-18T18:00:00Z',
	'2019-01-19T00:00:00Z',
	'2019-01-19T06:00:00Z',
	'2019-01-19T12:00:00Z',
	'2019-01-19T18:00:00Z',
	'2019-01-20T00:00:00Z',
	'2019-01-20T06:00:00Z',
	'2019-01-20T12:00:00Z',
	'2019-01-20T18:00:00Z',
	'2019-01-21T00:00:00Z',
	'2019-01-21T06:00:00Z',
	'2019-01-21T12:00:00Z',
	'2019-01-21T18:00:00Z',
	'2019-01-22T00:00:00Z',
	'2019-01-22T06:00:00Z',
	'2019-01-22T12:00:00Z',
	'2019-01-22T18:00:00Z',
	'2019-01-23T00:00:00Z',
	'2019-01-23T06:00:00Z',
	'2019-01-24T00:00:00Z',
	'2019-01-24T06:00:00Z',
	'2019-01-24T12:00:00Z',
	'2019-01-24T18:00:00Z',
	'2019-01-25T00:00:00Z',
	'2019-01-25T06:00:00Z',
	'2019-01-25T12:00:00Z',
	'2019-01-25T18:00:00Z',
	'2019-01-26T00:00:00Z',
	'2019-01-26T06:00:00Z',
	'2019-01-26T12:00:00Z',
	'2019-01-26T18:00:00Z',
	'2019-01-27T00:00:00Z',
	'2019-01-27T06:00:00Z',
	'2019-01-27T12:00:00Z',
	'2019-01-27T18:00:00Z',
	'2019-01-28T00:00:00Z',
	'2019-01-28T06:00:00Z',
	'2019-01-28T12:00:00Z',
	'2019-01-28T18:00:00Z',
	'2019-01-29T00:00:00Z',
	'2019-01-29T06:00:00Z',
	'2019-01-29T12:00:00Z',
	'2019-01-29T18:00:00Z',
	'2019-01-30T00:00:00Z',
	'2019-01-30T06:00:00Z',
	'2019-01-30T12:00:00Z',
	'2019-01-30T18:00:00Z',
	'2019-01-31T00:00:00Z',
	'2019-01-31T06:00:00Z',
	'2019-01-31T12:00:00Z',
	'2019-01-31T18:00:00Z',
	'2019-02-01T00:00:00Z',
	'2019-02-01T06:00:00Z',
	'2019-02-01T12:00:00Z',
	'2019-02-01T18:00:00Z',
	'2019-02-02T00:00:00Z',
	'2019-02-02T06:00:00Z',
	'2019-02-02T12:00:00Z',
	'2019-02-02T18:00:00Z',
	'2019-02-03T00:00:00Z',
	'2019-02-03T06:00:00Z',
	'2019-02-03T12:00:00Z',
	'2019-02-03T18:00:00Z',
	'2019-02-04T00:00:00Z',
	'2019-02-04T06:00:00Z',
	'2019-02-04T12:00:00Z',
	'2019-02-04T18:00:00Z',
	'2019-02-05T00:00:00Z',
	'2019-02-05T06:00:00Z',
	'2019-02-05T12:00:00Z',
	'2019-02-05T18:00:00Z',
	'2019-02-06T00:00:00Z',
	'2019-02-06T06:00:00Z',
	'2019-02-06T12:00:00Z',
	'2019-02-06T18:00:00Z',
	'2019-02-07T00:00:00Z',
	'2019-02-07T06:00:00Z',
	'2019-02-07T12:00:00Z',
	'2019-02-07T18:00:00Z',
	'2019-02-08T00:00:00Z',
	'2019-02-08T06:00:00Z',
	'2019-02-08T12:00:00Z',
	'2019-02-08T18:00:00Z',
	'2019-02-09T00:00:00Z',
	'2019-02-09T06:00:00Z',
	'2019-02-09T12:00:00Z',
	'2019-02-09T18:00:00Z',
	'2019-02-10T00:00:00Z',
	'2019-02-10T06:00:00Z',
	'2019-02-10T12:00:00Z',
	'2019-02-10T18:00:00Z',
	'2019-02-11T00:00:00Z',
	'2019-02-11T06:00:00Z',
	'2019-02-11T12:00:00Z',
	'2019-02-11T18:00:00Z',
	'2019-02-12T00:00:00Z',
	'2019-02-12T06:00:00Z',
	'2019-02-12T12:00:00Z',
	'2019-02-12T18:00:00Z',
	'2019-02-13T00:00:00Z',
	'2019-02-13T06:00:00Z',
	'2019-02-13T12:00:00Z',
	'2019-02-13T18:00:00Z',
	'2019-02-14T00:00:00Z',
	'2019-02-14T06:00:00Z',
	'2019-02-14T12:00:00Z',
	'2019-02-14T18:00:00Z',
	'2019-02-15T00:00:00Z',
	'2019-02-15T06:00:00Z',
	'2019-02-15T12:00:00Z',
	'2019-02-15T18:00:00Z',
	'2019-02-16T00:00:00Z',
	'2019-02-16T06:00:00Z',
	'2019-02-16T12:00:00Z',
	'2019-02-16T18:00:00Z',
	'2019-02-17T00:00:00Z',
	'2019-02-17T06:00:00Z',
	'2019-02-17T12:00:00Z',
	'2019-02-17T18:00:00Z',
	'2019-02-18T00:00:00Z',
	'2019-02-18T06:00:00Z',
	'2019-02-18T12:00:00Z',
	'2019-02-18T18:00:00Z',
	'2019-02-19T00:00:00Z',
	'2019-02-19T06:00:00Z',
	'2019-02-19T12:00:00Z',
	'2019-02-19T18:00:00Z',
	'2019-02-20T00:00:00Z',
	'2019-02-20T06:00:00Z',
	'2019-02-20T12:00:00Z',
	'2019-02-20T18:00:00Z',
	'2019-02-21T00:00:00Z',
	'2019-02-21T06:00:00Z',
	'2019-02-21T12:00:00Z',
	'2019-02-21T18:00:00Z',
	'2019-02-22T00:00:00Z',
	'2019-02-22T06:00:00Z',
	'2019-02-22T12:00:00Z',
	'2019-02-22T18:00:00Z',
	'2019-02-23T00:00:00Z',
	'2019-02-23T06:00:00Z',
	'2019-02-23T12:00:00Z',
	'2019-02-23T18:00:00Z',
	'2019-02-24T00:00:00Z',
	'2019-02-24T06:00:00Z',
	'2019-02-24T12:00:00Z',
	'2019-02-24T18:00:00Z',
	'2019-02-25T00:00:00Z',
	'2019-02-25T06:00:00Z',
	'2019-02-25T12:00:00Z',
	'2019-02-25T18:00:00Z',
	'2019-02-26T00:00:00Z',
	'2019-02-26T06:00:00Z',
	'2019-02-26T12:00:00Z',
	'2019-02-26T18:00:00Z',
	'2019-02-27T00:00:00Z',
	'2019-02-27T06:00:00Z',
	'2019-02-27T12:00:00Z',
	'2019-02-27T18:00:00Z',
	'2019-02-28T00:00:00Z',
	'2019-02-28T06:00:00Z',
	'2019-02-28T12:00:00Z',
	'2019-02-28T18:00:00Z',
	'2019-03-01T00:00:00Z',
	'2019-03-01T06:00:00Z',
	'2019-03-01T12:00:00Z',
	'2019-03-01T18:00:00Z',
	'2019-03-02T00:00:00Z',
	'2019-03-02T06:00:00Z',
	'2019-03-02T12:00:00Z',
	'2019-03-02T18:00:00Z',
	'2019-03-03T00:00:00Z',
	'2019-03-03T06:00:00Z',
	'2019-03-03T12:00:00Z',
	'2019-03-03T18:00:00Z',
	'2019-03-04T00:00:00Z',
	'2019-03-04T06:00:00Z',
	'2019-03-04T12:00:00Z',
	'2019-03-04T18:00:00Z',
	'2019-03-05T00:00:00Z',
	'2019-03-05T06:00:00Z',
	'2019-03-05T12:00:00Z',
	'2019-03-05T18:00:00Z',
	'2019-03-06T00:00:00Z',
	'2019-03-06T06:00:00Z',
	'2019-03-06T12:00:00Z',
	'2019-03-06T18:00:00Z',
	'2019-03-07T00:00:00Z',
	'2019-03-07T06:00:00Z',
	'2019-03-07T12:00:00Z',
	'2019-03-07T18:00:00Z',
	'2019-03-08T00:00:00Z',
	'2019-03-08T06:00:00Z',
	'2019-03-08T12:00:00Z',
	'2019-03-08T18:00:00Z',
	'2019-03-09T00:00:00Z',
	'2019-03-09T06:00:00Z',
	'2019-03-09T12:00:00Z',
	'2019-03-09T18:00:00Z',
	'2019-03-10T00:00:00Z'
	]) AS r
UNNEST r.mdata.data AS data
WHERE data.fcst_lead IN ['0', '6', '12', '18', '24', '30', '36', '42', '48', '54', '60', '66', '72', '78', '84', '90', '96', '102', '108', '114', '120', '126', '132', '138', '144', '150', '156', '162', '168', '174', '180', '186', '192', '198', '204', '210', '216', '222', '228', '234', '240', '252', '264', '276', '288', '300', '312', '324', '336', '348', '360', '372', '384']
ORDER BY data.fcst_valid_beg, data.fcst_init_beg, r.mdata.fcst_lev, data.fcst_lead, r.mdata.geoLocation_id;
EOF
echo $0 > "output/$0.time"
grep 'Time":' output/$0.json >> "output/$0.time"
cat "output/$0.json" | grep -vi select | jq -r '.results | (map(keys) | add | unique) as $cols | map(. as $row | $cols | map($row[.])) as $rows | $cols, $rows[] | @tsv' > "output/$0.tmp"
# first row is strings... match the column headers from sql output
#what we want
#vx_mask fcst_init_beg fibT fcst_valid_beg fvbT fcst_lead model fcst_lev fcst_var uoabar voabar ufabar vfabar uvooabar uvfoabar uvffabar total
#what we have
#1             2         3        4              5        6     7     8      9      10       11       12       13     14     15
#fcst_init_beg fcst_lead fcst_lev fcst_valid_beg fcst_var model total ufabar uoabar uvffabar uvfoabar uvooabar vfabar voabar vx_mask
head -1 output/$0.tmp |   awk '{printf "%s\t%s\tfibT\t%s\tfvbT\t%s\t%s\t%s\t%s\t%s\t%s\t%s\t%s\t%s\t%s\t%s\t%s\n", $15, $1,$4,$2,$6,$3,$5,$9,$14,$8,$13,$12,$11,$10,$7}' > "output/$0.tmpout"
# all the other rows are the data
tail -n+2 output/$0.tmp | awk '{printf "%s\t%s\t%s\t%i\t%s\t%s\t%s\t%.10f\t%.10f\t%.10f\t%.10f\t%.10f\t%.10f\t%.10f\t%i\n", $15, $1,$4,$2,$6,$3,$5,$9,$14,$8,$13,$12,$11,$10,$7}' | sed 's/\([0123456789]\)T\([0123456789]\)/\1 \2/g' | tr -d 'Z' >> "output/$0.tmpout"
cat output/$0.tmpout | column -t > output/$0.out
rm output/$0.tmpout
rm output/$0.tmp

